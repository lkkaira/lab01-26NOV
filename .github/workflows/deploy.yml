name: "Terraform Multi-Stage Deployment"

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "lab01-26NOV/**"

jobs:
  # ------------------- STAGE 1: Storage -------------------
  stage1-storage:
    name: "Stage 1: Deploy Storage"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Azure Login"
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v2

      - name: "Init & Apply Storage"
        working-directory: .
        run: |
          terraform init -input=false
          terraform apply -auto-approve -target=module.storage             -var-file="terraform.tfvars"

  # ------------------- STAGE 2: App Service Plan -------------------
  stage2-appserviceplan:
    name: "Stage 2: Deploy App Service Plan"
    runs-on: ubuntu-latest
    needs: [ stage1-storage ]
    steps:
      - uses: actions/checkout@v4

      - name: "Azure Login"
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v2

      - name: "Init & Apply App Service Plan"
        working-directory: .
        run: |
          terraform init -input=false
          terraform apply -auto-approve -target=module.appserviceplan             -var-file="terraform.tfvars"

  # ------------------- STAGE 3: Web App -------------------
  stage3-webapp:
    name: "Stage 3: Deploy Web App"
    runs-on: ubuntu-latest
    needs: [ stage2-appserviceplan ]
    steps:
      - uses: actions/checkout@v4

      - name: "Azure Login"
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v2

      - name: "Init & Apply Web App"
        working-directory: .
        run: |
          terraform init -input=false
          terraform apply -auto-approve -target=module.webapp             -var-file="terraform.tfvars"

  # ------------------- STAGE 4: Log Analytics -------------------
  stage4-loganalytics:
    name: "Stage 4: Deploy Log Analytics"
    runs-on: ubuntu-latest
    needs: [ stage3-webapp ]
    steps:
      - uses: actions/checkout@v4

      - name: "Azure Login"
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v2

      - name: "Init & Apply Log Analytics"
        working-directory: .
        run: |
          terraform init -input=false
          terraform apply -auto-approve -target=module.loganalytics             -var-file="terraform.tfvars"
